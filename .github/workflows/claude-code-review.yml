name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  # Quality gate - wait for CI quality checks to pass before running reviews
  await-quality:
    # Skip Dependabot PRs - secrets are not available to Dependabot-triggered workflows
    # for security reasons (prevents malicious dependencies from exfiltrating secrets)
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for quality checks
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'quality'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  # Security-focused review - OWASP Top 10, auth, data security
  security-review:
    needs: await-quality
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Use Node.js 24.x
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Query beads for known issues
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          # Extract epic ID from branch name (e.g., feature/workspace-123-description)
          EPIC_ID=$(echo "$HEAD_REF" | grep -oP 'workspace-\w+' || echo "")

          if [ -n "$EPIC_ID" ]; then
            echo "Found epic ID: $EPIC_ID"
            echo "EPIC_ID=$EPIC_ID" >> $GITHUB_ENV

            # Query open and ready tasks for this epic
            npx bd list --parent "$EPIC_ID" --status open --format json > known-issues.json || echo "[]" > known-issues.json
            npx bd list --parent "$EPIC_ID" --status ready --format json >> known-issues.json || true

            echo "Known issues queried from beads"
          else
            echo "No epic ID found in branch name"
            echo "[]" > known-issues.json
          fi

      - name: Run Security Review
        id: security-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Use the /security-review skill to review this pull request for security vulnerabilities.

            Review scope: Branch changes from ${{ github.event.pull_request.base.ref }} to HEAD.

            IMPORTANT - Known Issues Context:
            Before reporting issues, check the file known-issues.json for tasks already tracked in beads.
            These issues are already documented and should not be re-reported.
            If a finding relates to a known issue, reference it like: "Related to beads task workspace-123"
            Only report NEW security findings not already in known-issues.json.

            After generating the review, use `gh pr comment` to post the review as a comment on PR #${{ github.event.pull_request.number }}.

            Start your comment with:
            ## Security Review

            Use the repository's CLAUDE.md for context on project standards.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

  # Architecture-focused review - Clean Architecture compliance
  architecture-review:
    needs: await-quality
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Use Node.js 24.x
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Query beads for known issues
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          # Extract epic ID from branch name (e.g., feature/workspace-123-description)
          EPIC_ID=$(echo "$HEAD_REF" | grep -oP 'workspace-\w+' || echo "")

          if [ -n "$EPIC_ID" ]; then
            echo "Found epic ID: $EPIC_ID"
            echo "EPIC_ID=$EPIC_ID" >> $GITHUB_ENV

            # Query open and ready tasks for this epic
            npx bd list --parent "$EPIC_ID" --status open --format json > known-issues.json || echo "[]" > known-issues.json
            npx bd list --parent "$EPIC_ID" --status ready --format json >> known-issues.json || true

            echo "Known issues queried from beads"
          else
            echo "No epic ID found in branch name"
            echo "[]" > known-issues.json
          fi

      - name: Run Architecture Review
        id: architecture-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Use the /clean-architecture-validator skill to review this pull request for architectural compliance.

            Review scope: Branch changes from ${{ github.event.pull_request.base.ref }} to HEAD.

            IMPORTANT - Known Issues Context:
            Before reporting issues, check the file known-issues.json for tasks already tracked in beads.
            These issues are already documented and should not be re-reported.
            If a finding relates to a known issue, reference it like: "Related to beads task workspace-123"
            Only report NEW architecture findings not already in known-issues.json.

            After generating the review, use `gh pr comment` to post the review as a comment on PR #${{ github.event.pull_request.number }}.

            Start your comment with:
            ## Architecture Review

            Use the repository's CLAUDE.md for context on project standards.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

  # Code quality and test review - Correctness, maintainability, test quality
  quality-review:
    needs: await-quality
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Use Node.js 24.x
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Query beads for known issues
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          # Extract epic ID from branch name (e.g., feature/workspace-123-description)
          EPIC_ID=$(echo "$HEAD_REF" | grep -oP 'workspace-\w+' || echo "")

          if [ -n "$EPIC_ID" ]; then
            echo "Found epic ID: $EPIC_ID"
            echo "EPIC_ID=$EPIC_ID" >> $GITHUB_ENV

            # Query open and ready tasks for this epic
            npx bd list --parent "$EPIC_ID" --status open --format json > known-issues.json || echo "[]" > known-issues.json
            npx bd list --parent "$EPIC_ID" --status ready --format json >> known-issues.json || true

            echo "Known issues queried from beads"
          else
            echo "No epic ID found in branch name"
            echo "[]" > known-issues.json
          fi

      - name: Run Code Quality Review
        id: quality-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this pull request for code quality, correctness, and test quality.

            Review scope: Branch changes from ${{ github.event.pull_request.base.ref }} to HEAD.

            Focus areas:
            1. **What Changed** - Plain English summary of the changes
            2. **Does It Work** - Correctness and production-readiness
            3. **Test Quality** - Using Kent Beck's Test Desiderata (isolated, composable, fast, inspiring, writable, readable, behavioral, structure-insensitive, automated, specific, deterministic, predictive)
            4. **Simplicity** - Is the code simple and maintainable?
            5. **Code Quality** - Does it follow project standards in CLAUDE.md?

            DO NOT review security or architecture - those are covered by other review jobs.

            IMPORTANT - Known Issues Context:
            Before reporting issues, check the file known-issues.json for tasks already tracked in beads.
            These issues are already documented and should not be re-reported.
            If a finding relates to a known issue, reference it like: "Related to beads task workspace-123"
            Only report NEW quality findings not already in known-issues.json.

            After generating the review, use `gh pr comment` to post the review as a comment on PR #${{ github.event.pull_request.number }}.

            Start your comment with:
            ## Code Quality Review

            Organize findings by priority:
            - **Must Fix** - Blocks merge (correctness issues, failing tests, project standard violations)
            - **Should Fix** - Important but not blocking (test quality, simplicity improvements)
            - **Consider** - Optional suggestions (style preferences, future enhancements)

            Use the repository's CLAUDE.md for context on project standards.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
